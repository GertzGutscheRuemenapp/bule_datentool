<div class="legend" [ngClass]="{'edit': editMode}">
  <div class="legend-header">
    <div class="mini-fab-icon">
      <mat-icon>layers</mat-icon>
    </div>
    <span i18n>Legende</span>
    <ng-template #legendPopover>
      <p>Die Legende kann in zwei verschiedenen Ansichten dargestellt werden, zwischen denen durch Klick auf den Button rechts umgeschaltet werden kann.</p>
      <p>In der kompakten Ansicht werden in der Legende alle in der Karte aktiv angezeigten Layer und ihre Symbologie gruppiert aufgelistet.</p>
      <p>Im Editiermodus werden alle verfügbaren Layer angezeigt. Sie können einzelne Layer und ihre Darstellung in der Karte aktivieren und deaktivieren. Mit den Schiebereglern wird die Transparenz der jeweiligen Layer eingestellt.</p>
      <p>derzeit aktiv: <b *ngIf="editMode">Editiermodus</b> <b *ngIf="!editMode">kompakter Modus</b></p>
    </ng-template>
    <app-help-button style="margin: 0 5px;" [template]="legendPopover" title="Legende" position="left" [top]="-100">
    </app-help-button>
    <button title="In den Editiermodus umschalten" color="primary" *ngIf="!editMode" (click)="toggleEditMode()" mat-icon-button style="box-shadow: none; margin-left: auto;">
      <mat-icon>list</mat-icon>
    </button>
    <button title="In den kompakten Modus umschalten"
            color="primary" *ngIf="editMode"
            (click)="toggleEditMode()"
            mat-mini-fab style="box-shadow: none; margin-left: auto;">
      <mat-icon>list</mat-icon>
    </button>
  </div>
  <div class="legend-body">
    <div *ngFor="let group of layerGroups">
      <mat-expansion-panel [style.display]="editMode || (activeGroups.indexOf(group) >= 0) ? '': 'none'" expanded>
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{group.name}}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div *ngFor="let layer of group.children">
          <div class="legend-entry"
               [ngClass]="{'checked': checklistSelection.isSelected(layer)}"
               *ngIf="editMode || checklistSelection.isSelected(layer)">
            <div class="entry-header"
                 [ngbPopover]="popover"
                 placement="left"
                 container="body"
                 triggers="mouseenter:mouseleave">
              <ng-template #popover>
                <b>{{ layer.name }}</b>
                <p *ngIf="layer.description">{{ layer.description }}</p>
              </ng-template>
              <div class="entry-prefix">
                <div *ngIf="layer.symbol"
                     class="symbol"
                     [style.background]="layer.symbol.fillColor || 'white'"
                     [style.border-color]="layer.symbol.strokeColor || 'white'"
                     [class]="layer.symbol.symbol">
                </div>
                <mat-icon *ngIf="layer.legendUrl"
                          class="legend-image-link"
                          title="Legendenbild anzeigen"
                          (click)="toggleLegendImage(layer)">
                  image
                </mat-icon>
              </div>
              <div class="entry-title"
                   [style.cursor]="(editMode)? 'pointer': ''"
                   (click)="editMode && onLayerToggle(layer)">
                {{ layer.name }}
              </div>
            </div>
            <div class="legend-layer-control" [style.display]="editMode? '': 'none'">
              <mat-checkbox color="primary" [checked]="checklistSelection.isSelected(layer) || false"
                            (change)="onLayerToggle(layer)"
                            title="Layer anzeigen/verstecken">
              </mat-checkbox>
              <mat-slider aria-label="Transparenz" color="primary"
                          [disabled]="!checklistSelection.isSelected(layer)"
                          (input)="opacityChanged(layer, $event.value!)"
                          min="0" max="1" step="0.001"
                          [value]="layer.opacity"
                          title="Transparenz">
              </mat-slider>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </div>
    <mat-expansion-panel expanded>
      <mat-expansion-panel-header>
        <mat-panel-title i18n>
          Hintergrundkarte
        </mat-panel-title>
      </mat-expansion-panel-header>
      <ng-template #backSelectPopover>
        <b>{{ activeBackground?.name }}</b>
        <p *ngIf="activeBackground?.description">{{ activeBackground?.description }}</p>
      </ng-template>
      <div class="legend-entry">
        <div class="entry-header"
             [ngbPopover]="backSelectPopover"
             [disablePopover]="!activeBackground"
             placement="left"
             container="body"
             triggers="mouseenter:mouseleave">
          <div class="entry-prefix">
            <mat-icon *ngIf="activeBackground?.legendUrl"
                      class="legend-image-link"
                      title="Legendenbild anzeigen"
                      style="margin-top: 10px;"
                      (click)="toggleLegendImage(activeBackground!)">
              image
            </mat-icon>
          </div>
          <div class="entry-title">
            <mat-form-field appearance="outline" class="small">
              <mat-select disableRipple [(ngModel)]="activeBackgroundId"
                          (selectionChange)="
                            setBackground($event.value);
                            opacityChanged(activeBackground!, backgroundOpacity);">
                <mat-option [value]="-100000"> kein Hintergrund </mat-option>
                <ng-container *ngFor="let layer of backgroundLayers">
                  <ng-template #popover>
                    <b>{{ layer.name }}</b>
                    <p *ngIf="layer.description">{{ layer.description }}</p>
                  </ng-template>
                  <mat-option [ngbPopover]="popover"
                              placement="left"
                              container="body"
                              triggers="mouseenter:mouseleave"
                              [value]="layer.id">
                    {{layer.name}}
                  </mat-option>
                </ng-container>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <div class="legend-layer-control"
             [style.display]="(editMode && activeBackground)? '': 'none'"
             style="padding-left: 10px;">
          <mat-slider aria-label="Transparenz" color="primary"
                      style="margin-top: 10px;"
                      [(ngModel)]="backgroundOpacity"
                      (input)="opacityChanged(activeBackground!, $event.value)"
                      min="0" max="1" step="0.001">
          </mat-slider>
        </div>
      </div>
    </mat-expansion-panel>
  </div>
</div>

<ng-template #legendImage let-layer="layer">
  <img *ngIf="layer.legendUrl" [src]="layer.legendUrl + '&layer=' + layer.layerName">
</ng-template>
