<div *ngIf="mapControl" class="legend" [ngClass]="{'edit': mapControl.editMode }">
  <div class="legend-header">
    <div class="mini-fab-icon">
      <mat-icon>layers</mat-icon>
    </div>
    <span i18n>Legende</span>
    <ng-template #legendPopover>
      <p>Die Legende kann in zwei verschiedenen Ansichten dargestellt werden, zwischen denen durch Klick auf den Button rechts umgeschaltet werden kann.</p>
      <p>In der kompakten Ansicht werden in der Legende alle in der Karte aktiv angezeigten Layer und ihre Symbologie gruppiert aufgelistet.</p>
      <p>Im Editiermodus werden alle verfügbaren Layer angezeigt. Sie können einzelne Layer und ihre Darstellung in der Karte aktivieren und deaktivieren. Mit den Schiebereglern wird die Transparenz der jeweiligen Layer eingestellt.</p>
      <p>derzeit aktiv: <b *ngIf="mapControl.editMode">Editiermodus</b> <b *ngIf="!mapControl.editMode">kompakter Modus</b></p>
    </ng-template>
    <app-help-button style="margin: 0 5px;"
                     [template]="legendPopover"
                     title="Legende" position="left"
                     [top]="-100">
    </app-help-button>
    <button title="In den Editiermodus umschalten" color="primary" *ngIf="!mapControl.editMode" (click)="mapControl.toggleEditMode()" mat-icon-button style="box-shadow: none; margin-left: auto;">
      <mat-icon>list</mat-icon>
    </button>
    <button title="In den kompakten Modus umschalten"
            color="primary" *ngIf="mapControl.editMode"
            (click)="mapControl.toggleEditMode()"
            mat-mini-fab style="box-shadow: none; margin-left: auto;">
      <mat-icon>list</mat-icon>
    </button>
  </div>
  <div class="legend-body">
    <div *ngFor="let group of layerGroups">
      <mat-expansion-panel [style.display]="mapControl.editMode || (activeGroups.indexOf(group) >= 0) ? '': 'none'" expanded>
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{group.name}}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div *ngFor="let layer of group.children">
          <div class="legend-entry"
               [ngClass]="{'checked': mapControl.isSelected(layer)}"
               *ngIf="mapControl.editMode || mapControl.isSelected(layer)">
            <div class="entry-header"
                 [ngbPopover]="popover"
                 placement="left"
                 container="body"
                 triggers="mouseenter:mouseleave">
              <ng-template #popover>
                <b>{{ layer.name }}</b>
                <p *ngIf="layer.description">{{ layer.description }}</p>
              </ng-template>
              <div class="entry-prefix">
                <mat-checkbox *ngIf="mapControl.editMode"
                              color="primary"
                              [checked]="mapControl.isSelected(layer) || false"
                              (change)="toggleLayer(layer)"
                              title="Layer anzeigen/verstecken">
                </mat-checkbox>
                <ng-container *ngIf="!mapControl.editMode">
                  <ng-container *ngIf="layer.legend">
                    <div title="Farblegende des Layer ein-/ausklappen" (click)="toggleLayerLegend(layer)">
                      <mat-icon color="primary" *ngIf="layer.legend.elapsed">expand_less</mat-icon>
                      <mat-icon color="primary" *ngIf="!layer.legend.elapsed">expand_more</mat-icon>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="!layer.legend">
                    <div *ngIf="layer.symbol" style="cursor: pointer;"
                         class="symbol"
                         [style.background]="layer.symbol.fillColor || 'white'"
                         [style.border-color]="layer.symbol.strokeColor || 'white'"
                         [class]="layer.symbol.symbol">
                    </div>
                    <mat-icon *ngIf="layer.legendUrl"
                              class="legend-image-link"
                              title="Legendenbild anzeigen"
                              (click)="toggleLegendImage(layer)">
                      image
                    </mat-icon>
                  </ng-container>
                </ng-container>
              </div>
              <div class="entry-title"
                   [style.cursor]="layer.legend? 'pointer': ''"
                   (click)="toggleLayerLegend(layer)">
                {{ layer.name }}
              </div>
            </div>
            <div class="legend-layer-control" [style.display]="mapControl.editMode? '': 'none'">
              <mat-slider aria-label="Transparenz" color="primary"
                          [disabled]="!mapControl.isSelected(layer)"
                          min="100px"
                          (input)="mapControl.setLayerAttr(layer.id, { opacity: $event.value || undefined })"
                          min="0" max="1" step="0.001"
                          [value]="layer.opacity"
                          title="Transparenz">
              </mat-slider>
              <div class="label-toggle" *ngIf="layer.labelField"
                   (click)="toggleLabel(layer)" [title]="(layer.showLabel)? 'Labelanzeige ausschalten': 'Labelanzeige einschalten'">
                <mat-icon class="material-icons-outlined">
                  {{(layer.showLabel)? 'label': 'label_off'}}
                </mat-icon>
              </div>
            </div>
          </div>
          <div *ngIf="layer.legend && layer.legend.elapsed">
            <div class="legend-entry" *ngFor="let label of layer.legend.labels; let i = index;">
              <div class="entry-header">
                <div class="entry-prefix"></div>
                <div class="row-title">
                  <div class="row-label" style="display: flex">
                    <div *ngIf="layer.legend.colors"
                         [style.background]="layer.legend.colors[i]"
                         class="symbol"
                         style.border-color="black"
                         [class]="layer.symbol?.symbol? (layer.symbol?.symbol === 'line')? 'square': layer.symbol?.symbol: 'circle'">
                    </div>
                    {{label}}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </div>
    <mat-expansion-panel expanded>
      <mat-expansion-panel-header>
        <mat-panel-title i18n>
          Hintergrundkarte
        </mat-panel-title>
      </mat-expansion-panel-header>
      <ng-template #backSelectPopover>
        <b>{{ mapControl.background?.name }}</b>
        <p *ngIf="mapControl.background?.description">{{ mapControl.background?.description }}</p>
      </ng-template>
      <div class="legend-entry">
        <div class="entry-header"
             [ngbPopover]="backSelectPopover"
             [disablePopover]="!mapControl.background"
             placement="left"
             container="body"
             triggers="mouseenter:mouseleave">
          <div class="entry-prefix">
            <mat-icon *ngIf="mapControl.background?.legendUrl"
                      class="legend-image-link"
                      title="Legendenbild anzeigen"
                      style="margin-top: 10px;"
                      (click)="toggleLegendImage(mapControl.background!)">
              image
            </mat-icon>
          </div>
          <div class="entry-title">
            <mat-form-field appearance="outline" class="small">
              <mat-select disableRipple [value]="mapControl.background?.id || -100000"
                          (selectionChange)="mapControl.setBackground($event.value);">
                <mat-option [value]="-100000"> kein Hintergrund </mat-option>
                <ng-container *ngFor="let layer of mapControl.getBackgroundLayers()">
                  <ng-template #popover>
                    <b>{{ layer.name }}</b>
                    <p *ngIf="layer.description">{{ layer.description }}</p>
                  </ng-template>
                  <mat-option [ngbPopover]="popover"
                              placement="left"
                              container="body"
                              triggers="mouseenter:mouseleave"
                              [value]="layer.id">
                    {{layer.name}}
                  </mat-option>
                </ng-container>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <div class="legend-layer-control"
             [style.display]="(mapControl.editMode && mapControl.background)? '': 'none'"
             style="padding-left: 10px;">
          <mat-slider aria-label="Transparenz" color="primary"
                      style="margin-top: 10px;"
                      [value]="mapControl.backgroundOpacity"
                      (input)="mapControl.setLayerAttr(mapControl.background?.id, { opacity: $event.value || undefined })"
                      min="0" max="1" step="0.001">
          </mat-slider>
        </div>
      </div>
    </mat-expansion-panel>
  </div>
</div>

<ng-template #legendImage let-layer="layer">
  <img *ngIf="layer.legendUrl" [src]="layer.legendUrl + '&layer=' + layer.layerName">
</ng-template>
