<app-header-card [title]="'Projektdefinition'"
                 cookieId="exp-project-header"
                 width="930px">
  <b><i>ToDo: Hilfetext anpassen</i></b>
  <p>
    Für Ihre kommunale oder regionale Anwendung von daviplan müssen sie ein Projektgebiet festgelegt. Das Projektgebiet muss alle Gebietskörperschaften umfassen,
    für die Sie Infrastrukturen erfassen, Einwohnerentwicklungen betrachten, Nachfrage abschätzen, Szenarien der Infrastrukturentwicklung durchspielen und
    Versorgungsquoten ermitteln wollen. Auswertungen für Teilbereiche (z.B. einzelne Gemeinden oder Ortsteile) innerhalb dieses Projektgebiets sind möglich.
  </p>
</app-header-card>
<div fxLayout="row wrap">
  <div fxLayout="column" fxFlex="350px">
    <app-input-card #yearCard
                    [title]="'Betrachtungszeitraum'"
                    [editTemplate]="yearEdit"
                    infoText="<b><i>ToDo: Hilfetext</i></b>">
      <table>
        <tr>
          <td i18n>Betrachtungs-<br>zeitraum</td>
          <td>{{projectSettings?.startYear}} bis {{projectSettings?.endYear}}</td>
        </tr>
      </table>
    </app-input-card>
    <app-input-card #ageGroupCard
                    [title]="'Altersgruppeneinteilung'"
                    [editTemplate]="ageGroupsEdit"
                    dialogWidth="470px"
                    infoText="<b><i>ToDo: Hilfetext</i></b>">
      <table>
        <tr>
          <td i18n>Altersgruppen</td>
          <td>
            <ng-container *ngFor="let ageGroup of ageGroups">
              <ng-container *ngIf="ageGroup.toAge < 999">
                {{ageGroup.fromAge}} bis unter {{ageGroup.toAge + 1}} Jahre
              </ng-container>
              <ng-container *ngIf="ageGroup.toAge >= 999">
                {{ageGroup.fromAge}} Jahre und älter
              </ng-container>
              <br>
            </ng-container>
          </td>
        </tr>
      </table>
    </app-input-card>
  </div>
  <div fxLayout="column" fxFlex="600px">
    <app-input-card #areaCard
                    [title]="'Projektgebiet'"
                    subtitle="Manuelle Auswahl des Projektgebiets"
                    [topRightHelp]="true"
                    infoText="Um Ihr Projektgebiet festzulegen oder zu verändern, klicken Sie bitte auf „Editieren“. Sie gelangen dann zu einer Kartendarstellung, in der Sie Ihr Projektgebiet aus einzelnen Gemeinden, Verwaltungsgemeinschaften und Landkreisen zusammensetzen können."
                    [editTemplate]="projectAreaEdit"
                    dialogWidth="1200px">
      <div id="project-preview-map" class="map-container">
        <app-map-controls></app-map-controls>
      </div>
    </app-input-card>
  </div>
</div>

<ng-template #yearEdit>
  <form [formGroup]="yearForm">
    <div *ngIf="yearForm.errors">
      <mat-error *ngFor="let error of Object.values(yearForm.errors)" class="alert">
        {{ error }}
      </mat-error>
    </div>
    <mat-form-field appearance="outline" class="full">
      <mat-label i18n>Startjahr</mat-label>
      <input matInput type="number" min="1900" max="3000" formControlName="startYear" required>
      <mat-error *ngIf="yearForm.get('startYear')?.errors?.tooHigh" i18n>Das Startjahr muss vor dem Endjahr liegen</mat-error>
    </mat-form-field>
    <mat-form-field appearance="outline" class="full">
      <mat-label i18n>Endjahr</mat-label>
      <input matInput type="number" min="1900" max="3000" formControlName="endYear" required>
    </mat-form-field>
  </form>
</ng-template>

<ng-template #ageGroupsEdit>
  <div *ngIf="ageGroupErrors.length > 0">
    <mat-error *ngFor="let error of Object.values(ageGroupErrors)" class="alert">
      {{ error }}
    </mat-error>
  </div>
  <div class="age-group-container" #ageGroupContainer>
    <div>
      <div class="age-row" *ngFor="let ageGroup of __ageGroups; let i = index;">
        <mat-form-field appearance="outline" class="small">
          <mat-label i18n>{{(i < __ageGroups.length - 1) ? 'von': 'ab'}}</mat-label>
          <input matInput type="number"
                 [disabled]="i===0"
                 [min]="(i===0)? 0: __ageGroups![i-1].toAge + 1"
                 [max]="ageGroup.toAge - 1"
                 [(ngModel)]="ageGroup.fromAge"
                 (change)="ageGroupErrors = []"
                 required>
        </mat-form-field>
        <ng-container *ngIf="(i < __ageGroups.length-1)">
          &nbsp;-&nbsp;
          <mat-form-field appearance="outline" class="small">
            <mat-label i18n>bis</mat-label>
            <input matInput type="number"
                   [min]="ageGroup.fromAge + 1"
                   [max]="__ageGroups![i+1].fromAge - 1"
                   [(ngModel)]="ageGroup.toAge"
                   (change)="ageGroupErrors = []"
                   required>
            <mat-error *ngIf="yearForm.get('startYear')?.errors?.tooHigh" i18n>
              Das Startjahr muss vor dem Endjahr liegen
            </mat-error>
          </mat-form-field>
        </ng-container>
        Jahre
        <button mat-button color="primary"
                class="mat-button-dv"
                (click)="removeAgeGroup(ageGroup)"
                title="Altersgruppe entfernen"
                style="float: right;">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </div>
  <div>
    <button mat-button color="primary"
            class="mat-button-dv"
            (click)="addAgeGroup()"
            title="Altersgruppe hinzufügen" i18n>
      <mat-icon>add</mat-icon>hinzufügen
    </button>
    <button mat-button color="primary"
            class="mat-button-dv"
            (click)="removeAllAgeGroups()"
            style="margin-left: 30px;"
            title="Alle Altersgruppen entfernen" i18n>
      <mat-icon>close</mat-icon>Alle entfernen
    </button>
  </div>
  <button mat-button color="primary"
          class="mat-button-dv multiline-button"
          style="margin: 15px 0px;"
          (click)="resetAgeGroups()" i18n>
    <mat-icon>refresh</mat-icon>auf Defaults der Regionalstatistik zurücksetzen
  </button>
</ng-template>

<ng-template #projectAreaEdit>
  <div style="display: flex">
    <div style="width: 65%;">
      <mat-form-field appearance="outline" class="small">
        <mat-label>Verwaltungsebene</mat-label>
        <mat-select disableOptionCentering disableRipple
                    [disabled] = "!showAreaLayers"
                    (selectionChange)="changeAreaLayer()"
                    [(value)]="selectedAreaLayer">
          <mat-option [value]="layer" *ngFor="let layer of areaLayers">
            {{layer.name}}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-slide-toggle color="primary"
                        style="margin-left: 10px;"
                        [(ngModel)]="showAreaLayers"
                        (ngModelChange)="toggleLayerVisibility()">
        Gebietsauswahl {{showAreaLayers? 'aktiv': 'deaktiviert' }}
      </mat-slide-toggle>
      <mat-error *ngFor="let error of projectAreaErrors" class="alert">
        {{ error }}
      </mat-error>
      <div id="project-area-select-map" class="map-container">
        <app-map-controls></app-map-controls>
      </div>
    </div>
    <mat-divider vertical style="height: 650px; margin: 0 14px;"></mat-divider>
    <div style="width: 32%;"
         [style.display]="showAreaLayers? '': 'none'">
      <h4 style="font-size: 20px!important; margin-bottom: 5px;" i18n>Ausgewählte Gemeinden</h4>
      <div id="selected-area-list">
        <ul>
          <ng-container *ngFor="let baseFeat of baseAreasInExtent">
            <li title="aus der Auswahl entfernen"
                (click)= "toggleFeatureSelection(baseFeat)"
                *ngIf="baseFeat.get('inSelection')">
              {{baseFeat.get('gen')}}
              <mat-icon>close</mat-icon>
            </li>
          </ng-container>
        </ul>
      </div>
      <button mat-button color="primary"
              class="mat-button-dv"
              (click)="removeAreaSelections()"
              style="margin: 0 0 10px 10px"
              title="gesamte Auswahl entfernen" i18n>
        <mat-icon>close</mat-icon>Alle abwählen
      </button>
      <br>
      <h4 style="font-size: 20px!important; margin-bottom: 5px;" i18n>Nicht ausgewählte Gemeinden</h4>
      <div id="available-area-list">
        <ul>
          <ng-container *ngFor="let baseFeat of baseAreasInExtent">
            <li title="zur Auswahl hinzufügen"
                (click)= "toggleFeatureSelection(baseFeat)"
                *ngIf="!baseFeat.get('inSelection')">
              {{baseFeat.get('gen')}}
              <mat-icon>add</mat-icon>
            </li>
          </ng-container>
        </ul>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #ageGroupWarning>
  <div style="display: flex; align-items: end;">
    <p style="width: 80%">
      Die Altersgruppen stimmen nicht mit den Altersgruppen der Regionalstatistik überein.
    </p>
    <mat-icon class="material-icons-outlined warning" style="font-size: 40px; align-self: baseline;">report_problem</mat-icon>
  </div>
  <p>
    Sollen die definierten Altersgruppen dennoch übernommen werden?
  </p>
</ng-template>
